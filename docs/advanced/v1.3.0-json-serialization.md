# v1.3.0 - JSON Serialization with Serde

**üéØ Goal:** Replace custom text format with JSON using automatic serialization

**üì¶ The Problem We're Solving:**

**Before v1.3.0:**

Even with structs, we still had custom text parsing:

```rust
// Custom format:
"[ ] (high) Study Rust"
"[x] (low) Buy coffee"
"[ ] Read docs"

// Manual serialization in to_line():
fn to_line(&self) -> String {
    let checkbox = if self.completed { "[x]" } else { "[ ]" };
    let pri_str = match self.priority {
        Priority::High => " (high)",
        Priority::Low => " (low)",
        Priority::Medium => "",
    };
    format!("{}{} {}", checkbox, pri_str, self.text)
}

// Manual parsing in from_line():
fn from_line(line: &str) -> Option<Self> {
    // 25+ lines of parsing logic...
}
```

**Problems:**

‚ùå Custom format is fragile  
‚ùå Parsing logic is complex  
‚ùå Hard to add new fields (need to update parsing)  
‚ùå Not a standard format  
‚ùå Can't integrate with other tools  
‚ùå Manual maintenance of serialization  

**üì¶ The Solution: JSON with Serde**

**After v1.3.0:**

```json
[
  {
    "text": "Study Rust",
    "completed": false,
    "priority": "High"
  },
  {
    "text": "Buy coffee",
    "completed": true,
    "priority": "Low"
  },
  {
    "text": "Read docs",
    "completed": false,
    "priority": "Medium"
  }
]
```

**Why this is revolutionary:**

‚úÖ **Standard format** - universal, tools everywhere  
‚úÖ **Automatic serialization** - serde does everything  
‚úÖ **2 lines of code** for complete I/O  
‚úÖ **Trivial to extend** - add field = one line  
‚úÖ **Export/Import ready** - JSON is portable  
‚úÖ **Git-friendly** - readable diffs  

**üß† Key Concepts:**

### What is serialization?

**Serialization** = Converting data structures ‚Üí storage format  
**Deserialization** = Converting storage format ‚Üí data structures

```rust
// Serialization:
Task { text: "Study", completed: false, priority: High }
    ‚Üì
"{\"text\":\"Study\",\"completed\":false,\"priority\":\"High\"}"

// Deserialization:
"{\"text\":\"Study\",\"completed\":false,\"priority\":\"High\"}"
    ‚Üì
Task { text: "Study", completed: false, priority: High }
```

### Adding serde dependencies

**In `Cargo.toml`:**

```toml
[dependencies]
colored = "2.1"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
```

**What each does:**

| Crate | Purpose |
|-------|---------|
| `serde` | Core serialization framework |
| `features = ["derive"]` | Enables `#[derive(Serialize, Deserialize)]` macros |
| `serde_json` | JSON-specific implementation |

### The `#[derive(Serialize, Deserialize)]` attribute

**Add to imports:**

```rust
use serde::{Deserialize, Serialize};
```

**Add to types:**

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
struct Task {
    text: String,
    completed: bool,
    priority: Priority,
}

#[derive(Debug, Clone, PartialEq, Copy, Serialize, Deserialize)]
enum Priority {
    High,
    Medium,
    Low,
}
```

**What these derives do:**

**`Serialize`** - Generates code to convert type ‚Üí format  
**`Deserialize`** - Generates code to convert format ‚Üí type  

**The magic:**

```rust
// Before (manual - 37 lines):
impl Task {
    fn to_line(&self) -> String { /* 12 lines */ }
    fn from_line(line: &str) -> Option<Self> { /* 25 lines */ }
}

// After (automatic - 1 line):
#[derive(Serialize, Deserialize)]
// Generates 100+ lines of perfect serialization code!
```

### Refactored `load_tasks()` with JSON

**Before (custom text format):**

```rust
fn load_tasks() -> Result<Vec<Task>, Box<dyn Error>> {
    match fs::read_to_string("todos.txt") {
        Ok(content) => {
            let tasks: Vec<Task> = content
                .lines()
                .filter(|l| !l.trim().is_empty())
                .filter_map(Task::from_line)  // Manual parsing
                .collect();
            Ok(tasks)
        }
        Err(_) => Ok(Vec::new()),
    }
}
```

**After (JSON):**

```rust
fn load_tasks() -> Result<Vec<Task>, Box<dyn Error>> {
    match fs::read_to_string("todos.json") {  // .txt ‚Üí .json
        Ok(content) => {
            let tasks: Vec<Task> = serde_json::from_str(&content)?;  // ‚Üê ONE LINE!
            Ok(tasks)
        }
        Err(_) => Ok(Vec::new()),
    }
}
```

### Refactored `save_tasks()` with JSON

**Before (custom text format):**

```rust
fn save_tasks(tasks: &[Task]) -> Result<(), Box<dyn Error>> {
    let lines: Vec<String> = tasks.iter().map(|t| t.to_line()).collect();
    fs::write("todos.txt", lines.join("\n") + "\n")?;
    Ok(())
}
```

**After (JSON):**

```rust
fn save_tasks(tasks: &[Task]) -> Result<(), Box<dyn Error>> {
    let json = serde_json::to_string_pretty(tasks)?;  // ‚Üê ONE LINE!
    fs::write("todos.json", json)?;
    Ok(())
}
```

**Why `to_string_pretty` instead of `to_string`?**

```rust
// to_string - compact, one line:
serde_json::to_string(tasks)
// Output: [{"text":"Study","completed":false,"priority":"High"}]

// to_string_pretty - formatted, readable:
serde_json::to_string_pretty(tasks)
// Output:
// [
//   {
//     "text": "Study",
//     "completed": false,
//     "priority": "High"
//   }
// ]
```

### Impact of JSON migration

**Code reduction:**

| Component | Before | After | Reduction |
|-----------|--------|-------|-----------|
| `load_tasks()` | 12 lines | **3 lines** | -75% |
| `save_tasks()` | 4 lines | **2 lines** | -50% |
| `Task::from_line()` | 25 lines | **DELETED** | -100% |
| `Task::to_line()` | 12 lines | **DELETED** | -100% |
| **Total** | 53 lines | **5 lines** | **-91%** |

**91% reduction in I/O code!** üéØ

### Extensibility demonstration

**Adding tags support:**

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
struct Task {
    text: String,
    completed: bool,
    priority: Priority,
    #[serde(default)]  // ‚Üê Use empty vec if field missing
    tags: Vec<String>,  // ‚Üê Add ONE line
}
```

**That's it!** Serde now serializes/deserializes tags automatically.

**Example JSON:**

```json
[
  {
    "text": "Study Rust",
    "completed": false,
    "priority": "High",
    "tags": ["learning", "programming"]
  }
]
```

**No changes needed in:**

- ‚úÖ `load_tasks()` - still 3 lines
- ‚úÖ `save_tasks()` - still 2 lines
- ‚úÖ All commands - work automatically

**This is the power of declarative serialization!**

**üîó Resources:**

- [Code v1.3.0](https://github.com/joaofelipegalvao/todo-cli/tree/v1.3.0)
- [Full diff](https://github.com/joaofelipegalvao/todo-cli/compare/v1.2.0...v1.3.0)
- [Serde documentation](https://serde.rs/)
- [Serde JSON docs](https://docs.serde.rs/serde_json/)