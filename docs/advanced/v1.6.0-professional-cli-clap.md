# v1.6.0 - Professional CLI with Clap

**üéØ Goal:** Replace manual argument parsing with `clap` and migrate boolean flags to type-safe enums

**üì¶ The Problem We're Solving:**

**Before v1.6.0 - Manual parsing with conflicts:**

```rust
// Manual parsing:
let args: Vec<String> = env::args().collect();
if args.len() < 2 { return Err("Usage: ...".into()); }

let command = &args[1];
match command.as_str() {
    "add" => { /* manual parsing of flags */ }
    "list" => {
        let mut status_filter = "all";
        let mut priority_filter: Option<Priority> = None;
        let mut overdue = false;
        let mut due_soon = false;
        let mut with_due = false;
        let mut without_due = false;
        
        // Manual conflict checking:
        if overdue || due_soon || with_due || without_due {
            return Err("Use only one date filter".into());
        }
    }
}
```

**Problems:**

‚ùå Manual parsing (100+ lines just for flags)  
‚ùå Boolean flags conflict manually (`conflicts_with_all`)  
‚ùå Help text written by hand  
‚ùå No type safety (strings everywhere)  
‚ùå Hard to add new flags (lots of boilerplate)  
‚ùå Error messages generic  

**After v1.6.0 - Clap with enums:**

```rust
#[derive(Parser)]
struct Cli {
    #[command(subcommand)]
    command: Commands,
}

#[derive(Subcommand)]
enum Commands {
    List {
        #[arg(long, value_enum, default_value_t = StatusFilter::All)]
        status: StatusFilter,
        
        #[arg(long, value_enum)]
        due: Option<DueFilter>,
        
        // No conflicts - enums are mutually exclusive!
    }
}
```

**Benefits:**

‚úÖ **Zero manual parsing** - clap does everything  
‚úÖ **Zero conflicts** - enums are inherently exclusive  
‚úÖ **Auto-generated help** - beautiful and complete  
‚úÖ **Type-safe** - compiler validates everything  
‚úÖ **Easy to extend** - add enum value = done  
‚úÖ **Professional errors** - clap provides context  

**üß† Key Concepts:**

### What is Clap?

**Clap** = **C**ommand **L**ine **A**rgument **P**arser

The most popular CLI framework in Rust (used by cargo, ripgrep, bat, fd, etc.)

**Why clap?**

- ‚úÖ Derive macros - write structs, get parser
- ‚úÖ Auto-generated help/version
- ‚úÖ Subcommands support
- ‚úÖ Type-safe parsing
- ‚úÖ Shell completions
- ‚úÖ Industry standard

**Adding clap:**

```toml
[dependencies]
clap = { version = "4.5", features = ["derive"] }
```

**Feature `derive`** enables `#[derive(Parser)]` macros.

### The derive macro pattern

**Instead of manual parsing:**

```rust
// 50 lines of if/else/match
```

**Write declarative structs:**

```rust
#[derive(Parser)]
struct Cli {
    #[command(subcommand)]
    command: Commands,
}
```

**Clap generates:**

- Parsing logic
- Help text
- Error messages
- Validation
- Type conversions

**All automatically!**

### Main CLI structure

```rust
#[derive(Parser)]
#[command(name = "todo-list")]
#[command(author = "github.com/joaofelipegalvao")]
#[command(version = "1.6.0")]
#[command(about = "A modern, powerful task manager built with Rust")]
#[command(after_help = "EXAMPLES:
    todo add \"Task\" --priority high
    todo list --status pending
")]
struct Cli {
    #[command(subcommand)]
    command: Commands,
}
```

**Attributes explained:**

| Attribute | Purpose |
|-----------|---------|
| `#[command(name)]` | Program name in help |
| `#[command(author)]` | Shown in `--version` |
| `#[command(version)]` | Version string |
| `#[command(about)]` | Short description |
| `#[command(after_help)]` | Examples after help |

**Result:**

```bash
$ todo --help
A modern, powerful task manager built with Rust

Usage: todo-list <COMMAND>

Commands:
  add     Add a new task
  list    List and filter tasks
  ...

EXAMPLES:
    todo add "Task" --priority high
    todo list --status pending
```

### Subcommands with enum

```rust
#[derive(Subcommand)]
enum Commands {
    Add(AddArgs),
    List { ... },
    Done { id: usize },
    Remove { id: usize },
    Search { query: String },
    Tags,
    Clear,
}
```

**Pattern:**

- **Named fields** for simple args: `Done { id: usize }`
- **Separate struct** for complex args: `Add(AddArgs)`

### StatusFilter enum

**The problem we had:**

```rust
// Boolean flags:
let mut status_filter = "all";  // "all", "pending", or "done"

// Manual conflict checking:
if args.contains("--pending") && args.contains("--done") {
    return Err("Can't use both --pending and --done".into());
}
```

**The solution:**

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, ValueEnum)]
enum StatusFilter {
    /// Show only pending tasks
    Pending,
    /// Show only completed tasks
    Done,
    /// Show all tasks (default)
    All,
}
```

**What's `ValueEnum`?**

A clap trait that makes enums work as CLI values:

```bash
todo list --status pending  # Parses to StatusFilter::Pending
todo list --status done     # Parses to StatusFilter::Done
todo list --status all      # Parses to StatusFilter::All
```

**Usage in command:**

```rust
List {
    #[arg(long, value_enum, default_value_t = StatusFilter::All)]
    status: StatusFilter,
}
```

### DueFilter enum

**The old way - 4 boolean flags:**

```rust
let mut overdue = false;
let mut due_soon = false;
let mut with_due = false;
let mut without_due = false;

// Manual mutual exclusion:
if overdue || due_soon || with_due || without_due {
    return Err("Use only one date filter".into());
}
```

**The new way - 1 enum:**

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, ValueEnum)]
enum DueFilter {
    /// Tasks past their due date
    Overdue,
    /// Tasks due in the next 7 days
    Soon,
    /// Tasks with any due date set
    WithDue,
    /// Tasks without a due date
    NoDue,
}
```

**Benefits:**

| Aspect | 4 Booleans | 1 Enum |
|--------|------------|--------|
| Conflicts | Manual checking | Automatic (Option) |
| Validation | Runtime | Compile-time |
| Adding filter | +1 bool + conflict check | +1 enum variant |
| Help text | 4 separate flags | 1 organized group |
| Type safety | Can set multiple true | Impossible |

**Code reduction: 15 lines ‚Üí 3 lines**

### AddArgs structure

**Dedicated struct for complex command:**

```rust
#[derive(Args)]
struct AddArgs {
    /// Task description
    #[arg(value_name = "DESCRIPTION")]
    text: String,

    /// Task priority level
    #[arg(long, value_enum, default_value_t = Priority::Medium)]
    priority: Priority,

    /// Add tags (can be repeated: -t work -t urgent)
    #[arg(long, short = 't', value_name = "TAG")]
    tag: Vec<String>,

    /// Due date in format YYYY-MM-DD
    #[arg(long, value_name = "DATE", value_parser = clap::value_parser!(NaiveDate))]
    due: Option<NaiveDate>,
}
```

**Attributes explained:**

**`due` field:**

```rust
#[arg(long, value_name = "DATE", value_parser = clap::value_parser!(NaiveDate))]
due: Option<NaiveDate>,
```

- `value_parser!(NaiveDate)` - **THIS IS MAGIC**
- Clap automatically parses string ‚Üí NaiveDate
- Returns helpful error if invalid format

**Example usage:**

```bash
todo add "Deploy to production" \
    --priority high \
    --tag work \
    --tag deployment \
    --tag urgent \
    --due 2026-02-15
```

**All automatic!**

### Command aliases

**Before - single command name:**

```rust
"add" => { /* ... */ }
```

**After - multiple names:**

```rust
#[command(visible_alias = "a")]
Add(AddArgs),

#[command(visible_alias = "ls")]
List { /* ... */ },

#[command(visible_aliases = ["rm", "delete"])]
Remove { id: usize },
```

**Usage:**

```bash
# All equivalent:
todo add "Task"
todo a "Task"

# All equivalent:
todo list --status pending
todo ls --status pending

# All equivalent:
todo remove 3
todo rm 3
todo delete 3
```

### Auto-generated help

**Command-level help:**

```rust
#[command(long_about = "Add a new task to your todo list\n\n\
    Creates a new task with the specified text and optional metadata like priority,\n\
    tags, and due date. Tasks are saved immediately to todos.json.")]
Add(AddArgs),
```

**Result:**

```bash
$ todo add --help
Add a new task to your todo list

Creates a new task with the specified text and optional metadata like priority,
tags, and due date. Tasks are saved immediately to todos.json.

Usage: todo add <DESCRIPTION> [OPTIONS]

Arguments:
  <DESCRIPTION>  Task description

Options:
      --priority <PRIORITY>  Task priority level [default: medium]
  -t, --tag <TAG>           Add tags (can be repeated)
      --due <DATE>          Due date in format YYYY-MM-DD
  -h, --help                Print help
```

**All from struct attributes!**

**üîó Resources:**

- [Code v1.6.0](https://github.com/joaofelipegalvao/todo-cli/tree/v1.6.0)
- [Full diff](https://github.com/joaofelipegalvao/todo-cli/compare/v1.5.0...v1.6.0)
- [Clap documentation](https://docs.rs/clap/)